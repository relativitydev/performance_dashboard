
PRINT N'This update script will handle changes made in the 2013-06-06, 2013-06-25, 2013-08-02, and 2013-09-12 releases of PDB'
GO

PRINT N'2013-06-06 Changes'
PRINT N' Add DocumentCount to BISSummary table'
PRINT N' Add totalQTime to LRQCountDW table'
GO

IF COL_LENGTH('eddsdbo.BISSummary','DocumentCount') IS NULL
	BEGIN
		ALTER TABLE eddsdbo.BISSummary ADD [DocumentCount] [bigint] NULL
	END
GO

IF COL_LENGTH('eddsdbo.LRQCountDW','totalQtime') IS NULL
	BEGIN
		ALTER TABLE eddsdbo.LRQCountDW ADD [totalQtime] [int] NULL
	END
GO

PRINT N'2013-06-25 Changes'
PRINT N' UpdateBISScores sproc update'
PRINT N' GetBISHealthData sproc update'
GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[eddsdbo].UpdateBISScores') AND type in (N'P', N'PC'))
DROP PROCEDURE [eddsdbo].[UpdateBISScores]
GO
DECLARE @_ AS VARBINARY(MAX)
SET @_ = 0x0D000A002D002D0020003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D000D000A002D002D00200041007500740068006F0072003A000900090052006F006E0040004D0069006C0079006C0069000D000A002D002D002000430072006500610074006500200064006100740065003A00200032003000310032002D00300036002D00300031000D000A002D002D0020004400650073006300720069007000740069006F006E003A00090050006F00700075006C0061007400650020004200490053002000560061006C007500650073000D000A002D002D00200032003000310033002D00300032002D003100380020003A00200052006F006E0040004D0069006C0079006C00690020002D0020004D006F006400690066006900650064002000500065007200630065006E007400610067006500200074006F002000750073006500200054006F00740061006C004E005200510043006F0075006E0074002000610073002000640065006E006F006D0069006E00610074006F0072000D000A002D002D00200032003000310033002D00300032002D003100380020003A00200052006F006E0040004D0069006C0079006C00690020003A00200041006400640065006400200074006800650020006600690065006C006400200065006E006300720079007000740069006F006E00200063006F00640065000D000A002D002D00200032003000310033002D00300032002D003100380020003A00200052006F006E0040004D0069006C0079006C00690020003A0020005500700064006100740065006400200074006F0020004A006F00730068002700730020006D006F0073007400200075007000200074006F0020006400610074006500200063006F00640065000D000A002D002D00200032003000310033002D00300034002D003100390020003A00200052006F006E0040004D0069006C0079006C00690020003A002000410064006400650064002000490053004E0055004C004C00200063006800650063006B002000610072006F0075006E0064002000420053002E00530074006100740075007300500065007200630065006E0074006100670065004E0052004C00520051004400610079000D000A002D002D00200032003000310033002D00300034002D003100390020003A00200052006F006E0040004D0069006C0079006C00690020003A0020004100640064006500640020006C0069006D006900740065007200200074006F0020004E0069006E0065007400790044006100790043007500720073006F0072002E000D000A002D002D00200032003000310033002D00300034002D003200330020003A00200052006F006E0040004D0069006C0079006C00690020003A002000520065006D006F0076006500640020003900300020006400610079002000720075006E006E0069006E00670020006100760065007200610067006500200063006F00640065002E00200044006F006500730020006E006F0074002000610070007000650061007200200074006F00200062006500200064006900730070006C006100790065006400200069006E00200074006800650020004700550049002E000D000A002D002D00200032003000310033002D00300036002D003000360020003A00200052006F006E0040004D0069006C0079006C00690020003A0020004100640064006500640020006100640064006900740069006F006E0061006C0020006C006F00670069006300200074006F002000740061006B006500200069006E0074006F0020006100630063006F0075006E007400200044006F00630075006D0065006E007400200043006F0075006E00740073002000200020000D000A002D002D0020003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D000D000A004300520045004100540045002000500052004F0043004500440055005200450020005B006500640064007300640062006F005D002E005B00550070006400610074006500420049005300530063006F007200650073005D000D000A005700490054004800200045004E004300520059005000540049004F004E000D000A00410053000D000A0042004500470049004E000D000A000D000A00090053004500540020004E004F0043004F0055004E00540020004F004E003B000D000A0009000D000A0009004400450043004C004100520045002000400070007700640020004E005600610072006300680061007200280031003000300029000D000A0009005300450054002000400070007700640020003D00200027006B004300750072006100500061007300730077006F00720064003100210027000D000A000D000A0009002D002D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D000D000A0009000D000A0009002D002D00440065007400650072006D0069006E00650020007400680065002000700065007200630065006E00740061006700650020006F00660020004E0052004C005200510020007000650072002000640061007900200061006E0064002000750070006400610074006500200074006800650020006600690065006C0064000D000A00090055005000440041005400450020006500640064007300640062006F002E00420049005300530075006D006D0061007200790020000D000A0009005300450054002000530074006100740075007300500065007200630065006E0074006100670065004E0052004C005200510044006100790020003D00200043004F004E005600450052005400280069006E00740065006700650072002C0020002800490053004E0055004C004C002800280043004F004E005600450052005400280064006500630069006D0061006C002C0020004E0052004C005200510043006F0075006E007400290020002F0020004E0055004C004C0049004600280043004F004E005600450052005400280064006500630069006D0061006C002C00200054006F00740061006C004E005200510043006F0075006E00740029002C003000290029002C0030002900290020002A002000310030003000290009000D000A000D000A0009002D002D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D000D000A000D000A0009002D002D00440065007400650072006D0069006E0065002000740068006500200053007400610074007500730020007000650072002000640061007900200061006E0064002000750070006400610074006500200074006800650020006600690065006C0064000D000A00090055005000440041005400450020006500640064007300640062006F002E00420049005300530075006D006D006100720079000D000A000900530045005400200053007400610074007500730044006100790020003D0020000D000A000900090045006E006300720079007000740042007900500061007300730050006800720061007300650028000D000A0009000900090040007000770064002C000D000A0009000900090043004F004E00560045005200540028006E00760061007200630068006100720028006D006100780029002C000D000A0009000900090043004100530045000D000A0009000900090009002D002D004600610069006C002F0050006F006F0072000D000A0009000900090009005700480045004E00200028004E0052004C005200510043006F0075006E00740020003E003D002000350030002900200041004E0044002000280043004F0041004C004500530043004500280044006F00630075006D0065006E00740043006F0075006E0074002C003000290020003C003D00200031003000300030003000300030002900200041004E00440020002800530074006100740075007300500065007200630065006E0074006100670065004E0052004C005200510044006100790020003E003D00200031003500290020007400680065006E002000330020002D002D004600610069006C002F0050006F006F0072000D000A0009000900090009005700480045004E00200028004E0052004C005200510043006F0075006E00740020003E003D002000350030002900200041004E0044002000280043004F0041004C004500530043004500280044006F00630075006D0065006E00740043006F0075006E0074002C003000290020004200450054005700450045004E0020003100300030003000300030003100200041004E004400200033003000300030003000300030002900200041004E00440020002800530074006100740075007300500065007200630065006E0074006100670065004E0052004C005200510044006100790020003E003D002000320032002E003500290020007400680065006E002000330020002D002D004600610069006C002F0050006F006F0072000D000A0009000900090009005700480045004E00200028004E0052004C005200510043006F0075006E00740020003E003D002000350030002900200041004E0044002000280043004F0041004C004500530043004500280044006F00630075006D0065006E00740043006F0075006E0074002C003000290020004200450054005700450045004E0020003300300030003000300030003100200041004E004400200035003000300030003000300030002900200041004E00440020002800530074006100740075007300500065007200630065006E0074006100670065004E0052004C005200510044006100790020003E003D002000330032002E003500290020007400680065006E002000330020002D002D004600610069006C002F0050006F006F0072000D000A0009000900090009005700480045004E00200028004E0052004C005200510043006F0075006E00740020003E003D002000350030002900200041004E0044002000280043004F0041004C004500530043004500280044006F00630075006D0065006E00740043006F0075006E0074002C003000290020003E003D00200035003000300030003000300031002900200041004E00440020002800530074006100740075007300500065007200630065006E0074006100670065004E0052004C005200510044006100790020003E003D00200034003000290020007400680065006E002000330020002D002D004600610069006C002F0050006F006F0072000D000A0009000900090009002D002D00500072006F0062006100740069006F006E002F004D006F006400650072006100740065000D000A0009000900090009005700480045004E00200028004E0052004C005200510043006F0075006E00740020003E003D002000350030002900200041004E0044002000280043004F0041004C004500530043004500280044006F00630075006D0065006E00740043006F0075006E0074002C003000290020003C003D00200031003000300030003000300030002900200041004E00440020002800530074006100740075007300500065007200630065006E0074006100670065004E0052004C005200510044006100790020003E003D00200031003000290020007400680065006E002000320020002D002D00500072006F0062006100740069006F006E002F004D006F006400650072006100740065000D000A0009000900090009005700480045004E00200028004E0052004C005200510043006F0075006E00740020003E003D002000350030002900200041004E0044002000280043004F0041004C004500530043004500280044006F00630075006D0065006E00740043006F0075006E0074002C003000290020004200450054005700450045004E0020003100300030003000300030003100200041004E004400200033003000300030003000300030002900200041004E00440020002800530074006100740075007300500065007200630065006E0074006100670065004E0052004C005200510044006100790020003E003D002000310037002E003500290020007400680065006E002000320020002D002D00500072006F0062006100740069006F006E002F004D006F0064006500720061007400650020000D000A0009000900090009005700480045004E00200028004E0052004C005200510043006F0075006E00740020003E003D002000350030002900200041004E0044002000280043004F0041004C004500530043004500280044006F00630075006D0065006E00740043006F0075006E0074002C003000290020004200450054005700450045004E0020003300300030003000300030003100200041004E004400200035003000300030003000300030002900200041004E00440020002800530074006100740075007300500065007200630065006E0074006100670065004E0052004C005200510044006100790020003E003D002000320037002E003500290020007400680065006E002000320020002D002D00500072006F0062006100740069006F006E002F004D006F006400650072006100740065000D000A0009000900090009005700480045004E00200028004E0052004C005200510043006F0075006E00740020003E003D002000350030002900200041004E0044002000280043004F0041004C004500530043004500280044006F00630075006D0065006E00740043006F0075006E0074002C003000290020003E003D00200035003000300030003000300031002900200041004E00440020002800530074006100740075007300500065007200630065006E0074006100670065004E0052004C005200510044006100790020003E003D00200033003500290020007400680065006E002000320020002D002D00500072006F0062006100740069006F006E002F004D006F006400650072006100740065000D000A0009000900090009002D002D005000610073007300650064000D000A00090009000900090045004C00530045002000310020002D002D005000610073007300650064000D000A0009000900090045004E00440029002C000D000A0009000900090031002C000D000A0009000900090043004F004E00560045005200540028002000760061007200620069006E006100720079002C0020004D00650061007300750072006500440061007400650029000D000A000900090029000D000A000D000A0009002D002D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D003D000D000A0009000D000A0045004E004400
EXEC (@_)
GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[eddsdbo].[GetBISHealthData]') AND type in (N'P', N'PC'))
DROP PROCEDURE [eddsdbo].[GetBISHealthData]
GO
CREATE PROCEDURE [eddsdbo].[GetBISHealthData]
(
	@WorkspaceId int,
	@StartDate	DATETIME = NULL,
	@EndDate	DATETIME = NULL,
	@TimeZoneOffset int
)
WITH ENCRYPTION  
AS
BEGIN
	SET NOCOUNT ON;
	DECLARE @pwd NVarchar(100)
	SET @pwd = 'kCuraPassword1!'
	
	Set @TimeZoneOffset  = DATEDIFF(MINUTE, GETUTCDATE(), GETDATE()) * -1
	
	IF (@StartDate IS NULL AND @EndDate IS NULL)
		BEGIN
			SELECT @StartDate = DATEADD(HH,-23,DATEADD(HOUR, DATEDIFF(HH, 0, DATEADD(MINUTE, @TimeZoneOffset, GETUTCDATE())) ,0))				
			SET @EndDate = @StartDate			
		END
	ELSE
		BEGIN
			Set @StartDate = DATEADD(HOUR, DATEDIFF(HH, 0, DATEADD(MINUTE, @TimeZoneOffset, @StartDate)) ,0)
			Set @EndDate = DATEADD(HOUR, DATEDIFF(HH, 0, DATEADD(MINUTE, @TimeZoneOffset, @EndDate)) ,0)
		END
	
	SELECT
		ROW_NUMBER() OVER(ORDER BY WS.CaseArtifactID, DR.DateRange) AS Id								
		, WS.CaseArtifactID as CaseArtifactID
		, WS.WorkspaceName as WorkspaceName						
		, DR.DateRange as MeasureDate
		, ISNULL(PS.BISIndicator,0) AS BISIndicator
	FROM 
		[eddsdbo].GetDateRange(CAST(@StartDate as DATE), CAST(@EndDate as DATE)) DR
		CROSS JOIN 
		(
			SELECT DISTINCT 
				w.CaseArtifactID
				,w.WorkspaceName
			FROM 
				eddsdbo.EDDSWorkspace w 
			WHERE
				w.CaseArtifactID = @WorkspaceId
		) AS WS		
		LEFT JOIN 
		(
			SELECT 
				BS.CaseArtifactID
				, MeasureDate AS [MeasureDate]
				, Convert(int,
					  Convert(nvarchar(max), 
						DecryptByPassPhrase(@pwd, 
							CONVERT(nvarchar(max),BS.StatusDay), 
							1, 
							CONVERT( varbinary, MeasureDate)
						)
					)
				  ) AS [BISIndicator]
			FROM 
				eddsdbo.BISSummary BS
			WHERE 
				MeasureDate >=  CAST(@StartDate as DATE)
				AND MeasureDate < DATEADD(DAY, +1, CAST(@EndDate as DATE))
				AND BS.CaseArtifactID = @WorkspaceId
		) AS PS on PS.MeasureDate = dr.DateRange 
		AND WS.CaseArtifactID = PS.CaseArtifactID
END
GO

PRINT N'2013-08-02 and 08-19 Changes'
PRINT N' LoadBISSummary sproc changes (all inclusive, with 06-06 and 06-25 and 09-12 changes)'
GO

/****** Code Updated 2013-08-19 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[eddsdbo].[LoadBISSummary]') AND type in (N'P', N'PC'))
DROP PROCEDURE [eddsdbo].[LoadBISSummary]
GO
-- =============================================
-- Author:		Ron@Milyli
-- Create date: 2012-06-01
-- Description:	
-- 2013-02-18 : Ron@Milyli : Added new TotalNRQCount field
-- 2013-02-18 : Ron@Milyli : Added the field encryption code
-- 2013-06-05 : David@Milyli.com : added support for a timezone offset
-- 2013-08-01 : Ron@Milyli : Added DateAdd(DAY, DateDiff(DAY, 0, Cast(MeasureDate As datetime)), Cast(cast(MeasureHour as varchar) + '':00:00.000'' as datetime))
-- 2013-08-19 : Ron@Milyli : Added CAST( AS DATE) around the above calculation
-- 2013-09-10 : Ron@Milyli : Added in DocumentCount loader (this was missed in previous merge -- code orignally written 06/2013
-- =============================================
CREATEPROCEDURE [eddsdbo].[LoadBISSummary]
	@ProcessExecDate DateTime, 
	@TimeZoneOffset int
 
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @pwd NVarchar(100)
	SET @pwd = 'kCuraPassword1!'

	set @TimeZoneOffset  = DATEDIFF(MINUTE, GETUTCDATE(), GETDATE()) * -1
	
	Declare @SummaryMeasureDate DateTime
	Declare @MeasureDate Date
	
	--Select @MeasureDate = Cast(@ProcessExecDate as Date)
	Select @MeasureDate = DATEADD(HOUR, DATEDIFF(HH, 0, DATEADD(MINUTE, @TimeZoneOffset, @ProcessExecDate)) ,0)
	Select @SummaryMeasureDate = @MeasureDate

	--BISSummary data is already converted to local time
	IF EXISTS(Select 1 From eddsdbo.BISSummary Where MeasureDate = @SummaryMeasureDate)
	BEGIN 
	  --Existing data for the date, run an update
	  BEGIN TRAN
		UPDATE BISSummary
		SET TQCount = COALESCE(LC.TQCount,0),
			TotalNRQCount = COALESCE(LC.TotalNRQCount, 0),
			NRLRQCount = COALESCE(LC.NRLRQCount,0),
			DocumentCount = COALESCE(CS.DocumentCount,0)
		FROM
			eddsdbo.BISSummary BS
			
			LEFT JOIN
             (SELECT CaseArtifactID, DocumentCount
                FROM EDDS.eddsdbo.CaseStatistics
                WHERE (CAST(DATEADD(HOUR, DATEDIFF(HH, 0, DATEADD(MINUTE, @TimeZoneOffset, timestamp)), 0) AS DATE) = @MeasureDate)) AS CS 
                ON BS.CaseArtifactID = CS.CaseArtifactID 
				
			Left Join (Select CaseArtifactID, SUM(TotalQCount) TQCount, SUM(TotalNRQCount) TotalNRQCount, SUM(LRQCount) LRQCount, SUM(NRLRQCount) NRLRQCount   
			From eddsdbo.LRQCountDW where cast(DATEADD(HOUR, DATEDIFF(HH, 0, DATEADD(MINUTE, @TimeZoneOffset, DateAdd(DAY, DateDiff(DAY, 0, Cast(MeasureDate As datetime)), Cast(cast(MeasureHour as varchar) + ':00:00.000' as datetime)))) ,0) as DATE) = @MeasureDate Group By CaseArtifactID) LC
			On BS.CaseArtifactID = LC.CaseArtifactID 
			AND BS.MeasureDate = @MeasureDate	
			
	  COMMIT TRAN 

	END

	ELSE

	BEGIN
	    --New day, so do an initial insert
		BEGIN TRAN
 			INSERT BISSummary (CreatedOn, CaseArtifactID, MeasureDate, TQCount, TotalNRQCount, NRLRQCount, StatusDay, Status90Days, StatusPercentageNRLRQDay, StatusPercentageNRLRQ90Days, DocumentCount)
			SELECT 
				GetUTCDate() CreatedOn, 
				C.ArtifactID CaseArtifactID, 	
				@SummaryMeasureDate MeasureDate, 
				COALESCE(LC.TQCount,0) TQCount, 
			    COALESCE(LC.TotalNRQCount, 0) TotalNRQCount,
				COALESCE(LC.NRLRQCount,0) NRLRQCount, 
				EncryptByPassPhrase(@pwd,N'-1',1,CONVERT( varbinary, @SummaryMeasureDate)) StatusDay,
				EncryptByPassPhrase(@pwd,N'-1',1,CONVERT( varbinary, @SummaryMeasureDate)) Status90Days,
				-1  StatusPercentageNRLRQDay,
				-1 StatusPercentageNRLRQ90Days,
				COALESCE(CS.DocumentCount,0) DocumentCount
			From
			  EDDS.eddsdbo.[Case] C
			  
			  LEFT JOIN
                  (SELECT CaseArtifactID, DocumentCount
                    FROM EDDS.eddsdbo.CaseStatistics
                    WHERE (DATEADD(HOUR, DATEDIFF(HH, 0, DATEADD(MINUTE, @TimeZoneOffset, CAST(timestamp AS Date))), 0) = @MeasureDate)) AS CS 
                    ON C.ArtifactID = CS.CaseArtifactID 
					
			Left Join (Select CaseArtifactID, SUM(TotalQCount) TQCount, SUM(TotalNRQCount) TotalNRQCount, SUM(LRQCount) LRQCount, SUM(NRLRQCount) NRLRQCount   
			From eddsdbo.LRQCountDW 
			Where cast(DATEADD(HOUR, DATEDIFF(HH, 0, DATEADD(MINUTE, @TimeZoneOffset, DateAdd(DAY, DateDiff(DAY, 0, Cast(MeasureDate As datetime)), Cast(cast(MeasureHour as varchar) + ':00:00.000' as datetime)))) ,0) as DATE) = @MeasureDate Group By CaseArtifactID) LC
			On C.ArtifactID = LC.CaseArtifactID

		COMMIT TRAN
	END
END

GO

PRINT N'2013-09-12 Changes'
PRINT N' GetApplicationHealthData sproc change (updated logic)'
GO


/****** Code Updated 2013-09-12 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[eddsdbo].[GetApplicationHealthData]') AND type in (N'P', N'PC'))
DROP PROCEDURE [eddsdbo].[GetApplicationHealthData]
GO

CREATE PROCEDURE [eddsdbo].[GetApplicationHealthData]

	@StartDate	DATETIME = NULL,
	@EndDate	DATETIME = NULL,
	@TimeZoneOffset int

WITH ENCRYPTION
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
	DECLARE @pwd NVarchar(100)
	SET @pwd = 'kCuraPassword1!'
	
	--2013-09-30 - Ron@Milyli - Invert the timezone offset (testing - wip)
	SET @TimeZoneOffset = @TimeZoneOffset * -1
	
	IF (@StartDate IS NULL AND @EndDate IS NULL)
		BEGIN
			--SELECT @StartDate = DATEADD(HH, - 23, GETUTCDATE())
			SELECT @StartDate = DATEADD(HH,-23,DATEADD(HOUR, DATEDIFF(HH, 0, DATEADD(MINUTE, @TimeZoneOffset, GETUTCDATE())) ,0))				
			SET @EndDate = @StartDate			
		END
	
	-- Insert statements for procedure here
	 IF (@StartDate = @EndDate)		
		 BEGIN		 
			SELECT
				ROW_NUMBER() OVER(ORDER BY WS.CaseArtifactID, DateRange) AS Id				
				, ISNULL(WS.CaseArtifactID,0) as CaseArtifactID
				, ISNULL(WS.WorkspaceName,'') as WorkspaceName				
				, ISNULL(WS.[DatabaseLocation],'') as [DatabaseLocation]
				, dr.DateRange as MeasureDate
				, ISNULL(PS.UserCount, -1) AS UserCount
				, ISNULL(PS.ErrorCount, -1) AS ErrorCount
				, ISNULL(PS.LRQCount, -1) AS LRQCount
				, ISNULL(PS.AverageLatency,-1) AS AverageLatency
				,			CASE
				--Fail/Poor
				WHEN (BIS.NRLRQCount >= 50) AND (COALESCE(DocumentCount,0) <= 1000000) AND ( CONVERT(integer, (ISNULL((CONVERT(decimal, BIS.NRLRQCount) / NULLIF(CONVERT(decimal, TotalNRQCount),0)),0)) * 100) >= 15) then 3 --Fail/Poor
				WHEN (BIS.NRLRQCount >= 50) AND (COALESCE(DocumentCount,0) BETWEEN 1000001 AND 3000000) AND ( CONVERT(integer, (ISNULL((CONVERT(decimal, BIS.NRLRQCount) / NULLIF(CONVERT(decimal, TotalNRQCount),0)),0)) * 100) >= 22.5) then 3 --Fail/Poor
				WHEN (BIS.NRLRQCount >= 50) AND (COALESCE(DocumentCount,0) BETWEEN 3000001 AND 5000000) AND ( CONVERT(integer, (ISNULL((CONVERT(decimal, BIS.NRLRQCount) / NULLIF(CONVERT(decimal, TotalNRQCount),0)),0)) * 100) >= 32.5) then 3 --Fail/Poor
				WHEN (BIS.NRLRQCount >= 50) AND (COALESCE(DocumentCount,0) >= 5000001) AND ( CONVERT(integer, (ISNULL((CONVERT(decimal, BIS.NRLRQCount) / NULLIF(CONVERT(decimal, TotalNRQCount),0)),0)) * 100) >= 40) then 3 --Fail/Poor
				--Probation/Moderate
				WHEN (BIS.NRLRQCount >= 50) AND (COALESCE(DocumentCount,0) <= 1000000) AND ( CONVERT(integer, (ISNULL((CONVERT(decimal, BIS.NRLRQCount) / NULLIF(CONVERT(decimal, TotalNRQCount),0)),0)) * 100) >= 10) then 2 --Probation/Moderate
				WHEN (BIS.NRLRQCount >= 50) AND (COALESCE(DocumentCount,0) BETWEEN 1000001 AND 3000000) AND ( CONVERT(integer, (ISNULL((CONVERT(decimal, BIS.NRLRQCount) / NULLIF(CONVERT(decimal, TotalNRQCount),0)),0)) * 100) >= 17.5) then 2 --Probation/Moderate 
				WHEN (BIS.NRLRQCount >= 50) AND (COALESCE(DocumentCount,0) BETWEEN 3000001 AND 5000000) AND ( CONVERT(integer, (ISNULL((CONVERT(decimal, BIS.NRLRQCount) / NULLIF(CONVERT(decimal, TotalNRQCount),0)),0)) * 100) >= 27.5) then 2 --Probation/Moderate
				WHEN (BIS.NRLRQCount >= 50) AND (COALESCE(DocumentCount,0) >= 5000001) AND ( CONVERT(integer, (ISNULL((CONVERT(decimal, BIS.NRLRQCount) / NULLIF(CONVERT(decimal, TotalNRQCount),0)),0)) * 100) >= 35) then 2 --Probation/Moderate
				--Passed
				ELSE 1 --Passed
			END AS BISIndicator
				,ISNULL(BIS.TotalQCount,0) AS TQCount
			FROM [eddsdbo].GetDateRange(@StartDate, @EndDate) dr
				CROSS JOIN 
				(
					SELECT DISTINCT 
						w.CaseArtifactID
						, w.WorkspaceName
						, w.[DatabaseLocation]
					FROM eddsdbo.EDDSWorkspace w				
						JOIN eddsdbo.PerformanceSummary PC on PC.CaseArtifactID = w.CaseArtifactID 				
							AND DATEADD(MI, @TimeZoneOffset, MeasureDate) >= @StartDate 
							AND DATEADD(MI, @TimeZoneOffset, MeasureDate) < @EndDate + 1
				) as WS
				LEFT JOIN eddsdbo.PerformanceSummary PS
					ON DATEADD(MI, @TimeZoneOffset, DATEADD(HOUR, DATEPART(HOUR,MeasureDate), CONVERT(varchar(10), MeasureDate ,101))) = DATEADD(HOUR, DATEPART(HOUR,dr.DateRange), CONVERT(varchar(10), dr.DateRange,101))				    			  
						AND WS.CaseArtifactID = PS.CaseArtifactID
				LEFT JOIN EDDS.eddsdbo.CaseStatistics CS
					ON DATEADD(MI, @TimeZoneOffset, DATEADD(HOUR, DATEPART(HOUR,MeasureDate), CONVERT(varchar(10), MeasureDate ,101))) = DATEADD(HOUR, DATEPART(HOUR,dr.DateRange), CONVERT(varchar(10), dr.DateRange,101))				    			  
						AND WS.CaseArtifactID = CS.CaseArtifactID
				LEFT JOIN (
					SELECT
						LDW.CaseArtifactID AS CaseArtifactID,
						SUM(LDW.NRLRQCount) AS NRLRQCount,
						SUM(LDW.TotalQCount) AS TotalQCount
					FROM
						eddsdbo.LRQCountDW LDW
					WHERE
						DATEADD(MI, @TimeZoneOffset, DATEADD(HOUR,LDW.MeasureHour, cast(LDW.MeasureDate as datetime))) BETWEEN
						@StartDate AND @EndDate + 1
					GROUP BY
						LDW.CaseArtifactID
				) BIS 
					ON WS.CaseArtifactID = BIS.CaseArtifactID 						
		END
	ELSE		BEGIN	
			SELECT
				ROW_NUMBER() OVER(ORDER BY WS.CaseArtifactID, DateRange) AS Id								
				, WS.CaseArtifactID as CaseArtifactID
				, WS.WorkspaceName as WorkspaceName						
				, ISNULL(WS.[DatabaseLocation],'') as [DatabaseLocation]
				, dr.DateRange as MeasureDate
				, ISNULL(PS.UserCount, -1) AS UserCount
				, ISNULL(PS.ErrorCount, -1) AS ErrorCount
				, ISNULL(PS.LRQCount, -1) AS LRQCount
				, ISNULL(PS.AverageLatency,-1) AS AverageLatency
				, ISNULL(
					Convert(int, 
						Convert(nvarchar(max),					
							DecryptByPassPhrase(@pwd, 
								CONVERT(nvarchar(max),BIS.StatusDay), 
								1, 
								CONVERT( varbinary, BIS.MeasureDate)
							)
						)
					)				
				,0) AS BISIndicator
				, ISNULL(BIS.TQCount,0) AS TQCount
			FROM [eddsdbo].GetDateRange(@StartDate, @EndDate) dr
				CROSS JOIN 
				(
					SELECT DISTINCT 
						w.CaseArtifactID
						, w.WorkspaceName
						, w.[DatabaseLocation]
					FROM eddsdbo.EDDSWorkspace w				
						JOIN eddsdbo.PerformanceSummary PS on PS.CaseArtifactID = w.CaseArtifactID 
							AND DATEADD(MI, @TimeZoneOffset, MeasureDate) >= @StartDate 
							AND DATEADD(MI, @TimeZoneOffset, MeasureDate) < (@EndDate + 1)
				) as WS
				LEFT JOIN 
				(
					SELECT 
						PS.CaseArtifactID
						, DATEADD(DD, 0, DATEDIFF(DD, 0, DATEADD(MI, @TimeZoneOffset, MeasureDate))) [MeasureDate]
						, AVG(PS.UserCount) AS UserCount
						, SUM(PS.ErrorCount) AS ErrorCount
						, SUM(PS.LRQCount) AS LRQCount
						, AVG(PS.AverageLatency)  AS AverageLatency
					FROM eddsdbo.PerformanceSummary PS
					WHERE DATEADD(MI, @TimeZoneOffset,MeasureDate) >=  @StartDate 
						AND DATEADD(MI, @TimeZoneOffset,MeasureDate) < (@EndDate + 1)
					GROUP BY PS.CaseArtifactID
						, DATEADD(DD, 0, DATEDIFF(DD, 0, DATEADD(MI, @TimeZoneOffset, MeasureDate)))
				) as PS on PS.MeasureDate = dr.DateRange 
					AND WS.CaseArtifactID = PS.CaseArtifactID
				LEFT JOIN	
				eddsdbo.BISSummary BIS ON BIS.MeasureDate = DATEADD(DD, 0, dr.DateRange) AND WS.CaseArtifactID = BIS.CaseArtifactID 
		END	
END

GO

PRINT N'Done!'
GO
